<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure System v5.10 (Filtro Dinâmico)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- 1. VARIAVEIS & TEMA --- */
        :root { --primary: #00a79d; --bg: #f4f6f8; --sidebar: #262626; --card: #ffffff; --text: #333; --border: #e0e0e0; --hover: #f5f5f5; }
        body.dark-mode { --bg: #121212; --sidebar: #000000; --card: #1e1e1e; --text: #e0e0e0; --border: #333; --hover: #2a2a2a; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; transition: background 0.2s, color 0.2s; }
        body { height: 100vh; display: flex; background: var(--bg); color: var(--text); overflow: hidden; }

        /* --- 2. SIDEBAR --- */
        .sidebar { width: 260px; background: var(--sidebar); color: #aaa; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { height: 60px; background: var(--primary); color: white; display: flex; align-items: center; padding: 0 20px; font-weight: bold; }
        .menu-scroll { flex: 1; overflow-y: auto; padding-top: 10px; }
        .menu-btn { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-left: 4px solid transparent; color:#ccc; font-size:14px; }
        .menu-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .menu-btn.active { border-left-color: var(--primary); background: rgba(255,255,255,0.1); color: white; font-weight: 600; }
        .submenu { display: none; background: rgba(0,0,0,0.2); }
        .submenu.open { display: block; animation: slideDown 0.2s; }
        .sub-btn { padding: 10px 20px 10px 50px; font-size: 13px; cursor: pointer; color: #888; display: block; }
        .sub-btn:hover { color: white; }
        .sub-btn.active { color: var(--primary); font-weight: bold; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .sidebar-footer { padding: 20px; border-top: 1px solid #333; }

        /* --- 3. MAIN --- */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .topbar { height: 60px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .view { display: none; width:100%; height:100%; overflow-y: auto; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        .container-pad { padding: 30px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* UI */
        .card { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid var(--border); }
        .grid-3-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; height: 100%; } 
        
        h2, h3, h4 { color: var(--text); margin-bottom: 15px; font-weight: 600; }
        input, select { width: 100%; padding: 10px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; outline: none; margin-bottom: 10px; }
        input:focus, select:focus { border-color: var(--primary); }
        label { display: block; font-size: 11px; font-weight: bold; color: #888; margin-bottom: 5px; text-transform: uppercase; }

        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition:0.2s; display:inline-flex; align-items:center; gap:5px; justify-content:center; }
        .btn:hover { filter: brightness(0.9); }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: #ef4444; }
        .btn-dark { background: #333; }
        .btn-sm { padding: 5px 10px; font-size: 11px; }

        /* LISTS */
        .list-group { list-style: none; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; background: var(--card); }
        .list-item { padding: 12px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition:0.2s; }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background: var(--hover); padding-left:18px; }
        .list-item.active { background: rgba(0, 167, 157, 0.1); border-left: 4px solid var(--primary); color: var(--primary); font-weight: bold; }

        .rename-inp { border: none; border-bottom: 1px dashed #999; background: transparent; width: 100%; padding: 2px; color: var(--text); }
        .rename-inp:focus { outline: none; border-bottom: 2px solid var(--primary); }

        /* LOGIN & HERO */
        #login-screen { position: fixed; inset: 0; background: var(--sidebar); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--card); padding: 40px; width: 350px; border-radius: 8px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .hero { width: 100%; height: 100%; background: url('https://images.unsplash.com/photo-1497366216548-37526070297c?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80') center/cover; position: relative; }
        .hero-overlay { position: absolute; inset: 0; background: linear-gradient(135deg, rgba(0, 167, 157, 0.9), rgba(30, 200, 180, 0.6)); display: flex; flex-direction: column; justify-content: center; padding-left: 60px; color: white; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="margin-bottom:20px; border:none">Acesso Admin</h2>
            <input id="login-user" placeholder="admin">
            <input type="password" id="login-pass" placeholder="123">
            <button class="btn btn-primary" style="width:100%" onclick="Auth.login()">ENTRAR</button>
        </div>
    </div>

    <nav class="sidebar">
        <div class="sidebar-header"><i class="fas fa-shield-alt"></i> SECURE SYS v5.10</div>
        <div class="menu-scroll">
            <div class="menu-btn active" onclick="Nav.go('hero')"><i class="fas fa-home"></i> Início</div>
            
            <div class="menu-btn" onclick="Nav.toggleSub('sub-admin')">
                <i class="fas fa-cogs"></i> Administração <i class="fas fa-chevron-down" style="margin-left:auto; font-size:10px"></i>
            </div>
            <div id="sub-admin" class="submenu">
                <div class="sub-btn" onclick="Nav.go('admin-sites')">1. Sites (Locais)</div>
                <div class="sub-btn" onclick="Nav.go('admin-types')">2. Catálogo Tipos</div>
                <div class="sub-btn" onclick="Nav.go('admin-equips')">3. Instalação</div>
            </div>

            <div class="menu-btn" onclick="Nav.go('checklist')"><i class="fas fa-check-square"></i> Checklist</div>
            <div class="menu-btn" onclick="Nav.go('os')"><i class="fas fa-tools"></i> Manutenção</div>
        </div>
        <div class="sidebar-footer">
            <button class="btn btn-danger" style="width:100%; font-size:11px" onclick="DB.reset()"><i class="fas fa-trash"></i> RESETAR DADOS</button>
        </div>
    </nav>

    <main class="main">
        <div class="topbar">
            <h3>Bem-vindo</h3>
            <button class="btn btn-dark" onclick="App.toggleTheme()"><i class="fas fa-adjust"></i> Tema</button>
        </div>

        <div id="view-hero" class="view active" style="padding:0">
            <div class="hero">
                <div class="hero-overlay">
                    <h1 style="font-size:48px; font-weight:800; margin-bottom:10px">Sistema Integrado</h1>
                    <p style="font-size:22px; opacity:0.9">Gestão de Ativos e Segurança</p>
                </div>
            </div>
        </div>

        <div id="view-admin-sites" class="view container-pad">
            <div class="card">
                <h2 style="color:var(--primary)">1. Gerenciar Sites</h2>
                <div style="display:flex; gap:10px; margin-bottom:20px">
                    <input id="site-name" placeholder="Nome do Local (ex: Unidade Centro)" style="margin:0">
                    <button class="btn btn-primary" onclick="AdmSites.add()">Adicionar</button>
                </div>
                <ul id="site-list" class="list-group"></ul>
            </div>
        </div>

        <div id="view-admin-types" class="view container-pad">
            <div class="card">
                <h2 style="color:var(--primary)">2. Catálogo de Tipos</h2>
                <div style="display:flex; gap:10px; margin-bottom:20px">
                    <input id="type-name" placeholder="Nome do Tipo (ex: Câmera IP, Catraca)" style="margin:0">
                    <button class="btn btn-primary" onclick="AdmTypes.add()">Adicionar</button>
                </div>
                <ul id="type-list" class="list-group"></ul>
            </div>
        </div>

        <div id="view-admin-equips" class="view container-pad">
            <h2 style="margin-bottom:20px; color:var(--primary)">3. Instalação e Configuração</h2>
            
            <div class="card" style="border-left: 5px solid var(--primary)">
                <label>PASSO 1: Selecione o Local</label>
                <select id="eq-site-select" onchange="AdmInst.onSiteChange()" style="margin:0"></select>
            </div>

            <div id="eq-panel" style="display:none; height: calc(100vh - 250px);">
                <div class="grid-3-col">
                    
                    <div class="card" style="display:flex; flex-direction:column">
                        <h4>PASSO 2: Selecione o Tipo</h4>
                        <p style="font-size:12px; color:#888">Isso filtrará a lista ao lado:</p>
                        <ul id="catalog-list" class="list-group" style="flex:1; overflow-y:auto"></ul>
                    </div>

                    <div class="card" style="display:flex; flex-direction:column; border-color:var(--primary)">
                        <h4 id="group-col-title">PASSO 3: Grupos</h4>
                        
                        <div id="create-group-form" style="display:none; background:rgba(0, 167, 157, 0.05); padding:15px; border-radius:6px; margin-bottom:15px; border:1px dashed var(--primary)">
                            <label style="color:var(--primary)">Novo Grupo</label>
                            <input id="group-name-in" placeholder="Nome (Ex: Câmeras Hall)">
                            <div style="display:flex; gap:5px; align-items:flex-end">
                                <div style="flex:1"><label>Qtd Inicial</label><input type="number" id="group-qty-in" value="1" min="1" style="margin:0"></div>
                                <button class="btn btn-primary" onclick="AdmInst.createGroup()">Criar</button>
                            </div>
                        </div>

                        <div id="groups-placeholder" style="text-align:center; color:#888; padding:20px; display:block">
                            Selecione um tipo no Passo 2 para ver ou criar grupos.
                        </div>

                        <ul id="group-list" class="list-group" style="flex:1; overflow-y:auto; display:none"></ul>
                    </div>

                    <div class="card" style="display:flex; flex-direction:column">
                        <h4>PASSO 4: Itens</h4>
                        <div id="item-msg" style="text-align:center; color:#888; margin-top:50px">
                            <i class="fas fa-arrow-left"></i> Selecione um grupo no Passo 3
                        </div>
                        <div id="item-list-box" style="display:none; flex:1; display:flex; flex-direction:column">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px">
                                <small>Renomeie os itens:</small>
                                <button class="btn btn-sm btn-primary" onclick="AdmInst.addOneMore()">+1 Item</button>
                            </div>
                            <ul id="item-list" class="list-group" style="flex:1; overflow-y:auto"></ul>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="view-checklist" class="view container-pad">
            <div class="card"><h2 style="margin-bottom:10px">Checklist Diário</h2><div style="display:flex; gap:10px"><input type="date" id="chk-date"><select id="chk-site"></select><button class="btn btn-primary" onclick="Checklist.load()">Carregar</button></div></div>
            <div id="chk-container"></div>
        </div>

        <div id="view-os" class="view container-pad"><div class="card"><h2>Manutenção</h2><p>Módulo de O.S. mantido.</p></div></div>

    </main>

    <script>
        // --- DB ---
        const DB = {
            data: { sites: [], types: [], groups: [], equips: [], checks: [] },
            init: () => { 
                const s = localStorage.getItem('sys_v510'); 
                if(s) DB.data = JSON.parse(s); 
                else DB.seed(); 
            },
            save: () => localStorage.setItem('sys_v510', JSON.stringify(DB.data)),
            seed: () => {
                DB.data.sites = [{id:1, name:'Matriz SP'}];
                DB.data.types = [{id:10, name:'Câmera IP'}, {id:20, name:'Catraca'}];
                DB.save();
            },
            reset: () => { localStorage.removeItem('sys_v510'); location.reload(); },
            export: () => { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(DB.data)],{type:'application/json'})); a.download='backup.json'; a.click(); },
            import: (inp) => { const fr=new FileReader(); fr.onload=(e)=>{ if(confirm("Restaurar?")){ DB.data=JSON.parse(e.target.result); DB.save(); location.reload(); }}; fr.readAsText(inp.files[0]); }
        };

        // --- 1. SITES ---
        const AdmSites = {
            render: () => {
                document.getElementById('site-list').innerHTML = DB.data.sites.map(s => 
                    `<li class="list-item"><b>${s.name}</b> <button class="btn btn-sm btn-danger" onclick="AdmSites.del(${s.id})"><i class="fas fa-trash"></i></button></li>`
                ).join('');
            },
            add: () => {
                const n = document.getElementById('site-name').value;
                if(n) { DB.data.sites.push({id:Date.now(), name:n}); DB.save(); document.getElementById('site-name').value=''; AdmSites.render(); }
            },
            del: (id) => { if(confirm('Del?')) { DB.data.sites=DB.data.sites.filter(x=>x.id!==id); DB.save(); AdmSites.render(); } }
        };

        // --- 2. TYPES ---
        const AdmTypes = {
            render: () => {
                document.getElementById('type-list').innerHTML = DB.data.types.map(t => 
                    `<li class="list-item"><b>${t.name}</b> <button class="btn btn-sm btn-danger" onclick="AdmTypes.del(${t.id})"><i class="fas fa-trash"></i></button></li>`
                ).join('');
            },
            add: () => {
                const n = document.getElementById('type-name').value;
                if(n) { DB.data.types.push({id:Date.now(), name:n}); DB.save(); document.getElementById('type-name').value=''; AdmTypes.render(); }
            },
            del: (id) => { if(confirm('Del?')) { DB.data.types=DB.data.types.filter(x=>x.id!==id); DB.save(); AdmTypes.render(); } }
        };

        // --- 3. INSTALAÇÃO (FILTRO DINAMICO) ---
        const AdmInst = {
            currSite: null, currTypeId: null, currGroup: null,
            
            init: () => {
                document.getElementById('eq-site-select').innerHTML = '<option value="">Selecione...</option>' + DB.data.sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                document.getElementById('eq-panel').style.display = 'none';
            },

            onSiteChange: () => {
                const v = document.getElementById('eq-site-select').value;
                if(!v) { document.getElementById('eq-panel').style.display='none'; return; }
                
                AdmInst.currSite = parseInt(v);
                document.getElementById('eq-panel').style.display='block';
                
                // Reset selections
                AdmInst.currTypeId = null;
                AdmInst.currGroup = null;

                // Render Catalogo (Passo 2)
                document.getElementById('catalog-list').innerHTML = DB.data.types.map(t => 
                    `<li class="list-item" onclick="AdmInst.selectType(${t.id})"><span>${t.name}</span> <i class="fas fa-chevron-right"></i></li>`
                ).join('');
                
                // Reset Panels
                document.getElementById('create-group-form').style.display='none';
                document.getElementById('group-list').style.display='none';
                document.getElementById('groups-placeholder').style.display='block';
                document.getElementById('item-list-box').style.display='none';
                document.getElementById('item-msg').style.display='block';
            },

            // PASSO 2: Seleciona Tipo -> FILTRA O PASSO 3
            selectType: (tid) => {
                AdmInst.currTypeId = tid;
                AdmInst.currGroup = null; // Reset group selection
                
                const t = DB.data.types.find(x => x.id === tid);
                
                // Highlight Step 2
                Array.from(document.querySelectorAll('#catalog-list .list-item')).forEach(el => el.classList.remove('active'));
                event.currentTarget.classList.add('active');

                // Prepare Step 3 UI
                document.getElementById('group-col-title').innerText = `PASSO 3: Grupos de ${t.name}`;
                document.getElementById('create-group-form').style.display='block';
                document.getElementById('group-name-in').value = t.name;
                
                document.getElementById('groups-placeholder').style.display='none';
                document.getElementById('group-list').style.display='block';
                
                // Filter Groups!
                AdmInst.renderGroups();
                
                // Hide Step 4 until group selected
                document.getElementById('item-list-box').style.display='none';
                document.getElementById('item-msg').style.display='block';
            },

            // PASSO 3: Cria Grupo
            createGroup: () => {
                const name = document.getElementById('group-name-in').value;
                const qty = parseInt(document.getElementById('group-qty-in').value);
                
                if(name && qty > 0) {
                    const gid = Date.now();
                    DB.data.groups.push({ id: gid, siteId: AdmInst.currSite, typeId: AdmInst.currTypeId, name: name });
                    
                    for(let i=0; i<qty; i++) {
                        let num = i+1;
                        DB.data.equips.push({
                            id: Date.now() + i, groupId: gid, siteId: AdmInst.currSite, 
                            name: `${name} ${num<10?'0'+num:num}`
                        });
                    }
                    DB.save();
                    AdmInst.renderGroups();
                    AdmInst.selectGroup(gid);
                }
            },

            // Renderiza APENAS os grupos do Tipo Selecionado
            renderGroups: () => {
                // FILTER LOGIC HERE
                const groups = DB.data.groups.filter(g => g.siteId === AdmInst.currSite && g.typeId === AdmInst.currTypeId);
                
                document.getElementById('group-list').innerHTML = groups.map(g => {
                    const count = DB.data.equips.filter(e => e.groupId === g.id).length;
                    return `<li class="list-item ${AdmInst.currGroup===g.id?'active':''}" onclick="AdmInst.selectGroup(${g.id})">
                        <span>${g.name}</span> <span class="btn-sm btn-dark">${count}</span>
                    </li>`;
                }).join('');
            },

            // PASSO 3B: Seleciona Grupo
            selectGroup: (gid) => {
                AdmInst.currGroup = gid;
                AdmInst.renderGroups(); // Update highlight
                
                document.getElementById('item-msg').style.display='none';
                document.getElementById('item-list-box').style.display='flex';
                AdmInst.renderItems();
            },

            addOneMore: () => {
                if(!AdmInst.currGroup) return;
                const grp = DB.data.groups.find(g=>g.id===AdmInst.currGroup);
                const count = DB.data.equips.filter(e=>e.groupId===AdmInst.currGroup).length + 1;
                DB.data.equips.push({
                    id: Date.now(), groupId: AdmInst.currGroup, siteId: AdmInst.currSite,
                    name: `${grp.name} ${count<10?'0'+count:count}`
                });
                DB.save(); AdmInst.renderItems(); AdmInst.renderGroups();
            },

            // PASSO 4: Lista Itens
            renderItems: () => {
                const items = DB.data.equips.filter(e => e.groupId === AdmInst.currGroup);
                document.getElementById('item-list').innerHTML = items.map(e => `
                    <li class="list-item">
                        <input class="rename-inp" value="${e.name}" onchange="AdmInst.rename(${e.id}, this.value)">
                        <button class="btn btn-sm btn-danger" tabindex="-1" onclick="AdmInst.delItem(${e.id})"><i class="fas fa-trash"></i></button>
                    </li>
                `).join('');
            },

            rename: (id, v) => { const e = DB.data.equips.find(x=>x.id===id); if(e){ e.name=v; DB.save(); } },
            delItem: (id) => { if(confirm('Del?')) { DB.data.equips=DB.data.equips.filter(x=>x.id!==id); DB.save(); AdmInst.renderItems(); AdmInst.renderGroups(); } }
        };

        // --- CHECKLIST ---
        const Checklist = {
            init: () => {
                document.getElementById('chk-date').valueAsDate = new Date();
                document.getElementById('chk-site').innerHTML = DB.data.sites.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
                Checklist.load();
            },
            load: () => {
                const sid = parseInt(document.getElementById('chk-site').value);
                const items = DB.data.equips.filter(e => e.siteId === sid);
                document.getElementById('chk-container').innerHTML = items.map(i => 
                    `<div class="card" style="padding:10px; margin-bottom:10px; display:flex; justify-content:space-between">
                        <strong>${i.name}</strong>
                        <select style="width:100px; padding:5px"><option>OK</option><option>Erro</option></select>
                    </div>`
                ).join('') || '<p style="text-align:center; padding:20px">Vazio</p>';
            }
        };

        // --- APP ---
        const Auth = {
            login: () => { if(document.getElementById('login-user').value==='admin'){ document.getElementById('login-screen').style.display='none'; App.init(); Nav.go('hero'); } else alert('Erro'); },
            logout: () => location.reload()
        };
        const App = {
            init: () => { DB.init(); },
            toggleTheme: () => document.body.classList.toggle('dark-mode')
        };
        const Nav = {
            toggleSub: (id) => document.getElementById(id).classList.toggle('open'),
            go: (v) => {
                document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));
                document.getElementById('view-'+v).classList.add('active');
                
                if(v.includes('admin-')) {
                    document.getElementById('sub-admin').classList.add('open');
                    if(v==='admin-sites') AdmSites.render();
                    if(v==='admin-types') AdmTypes.render();
                    if(v==='admin-equips') AdmInst.init();
                }
                if(v==='checklist') Checklist.init();
            }
        };
    </script>
</body>
</html>s